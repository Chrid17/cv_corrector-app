import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../../core/constants/app_colors.dart';
import '../../core/constants/app_text_styles.dart';
import '../../domain/entities/cv_analysis.dart';
import 'tabs/overview_tab.dart';
import 'tabs/corrections_tab.dart';
import 'tabs/keywords_tab.dart';
import 'tabs/cover_letter_tab.dart';
import 'tabs/interview_tab.dart';
import 'tabs/skills_tab.dart';
import 'tabs/proposed_changes_tab.dart';
import 'tabs/job_match_tab.dart';
import 'tabs/company_research_tab.dart';
import 'tabs/learning_path_tab.dart';
class ResultScreen extends StatefulWidget {
  final CvAnalysis result;
  const ResultScreen({super.key, required this.result});

  @override
  State<ResultScreen> createState() => _ResultScreenState();
}

class _ResultScreenState extends State<ResultScreen> with TickerProviderStateMixin {
  late final TabController _tabController;
  late final List<String> _tabs;
  late final List<Widget> _tabViews;

  @override
  void initState() {
    super.initState();
    final r = widget.result;

    _tabs = [
      'Overview',
      'Corrections',
      'Proposals',
      if (r.hasJobMatch) 'JD Match',
      if (r.hasCompanyResearch) 'Company',
      'Keywords',
      'Skills',
      'Cover Letter',
      'Interview',
      'Learning Path',
    ];

    _tabViews = [
      OverviewTab(result: r),
      CorrectionsTab(result: r),
      const ProposedChangesTab(),
      if (r.hasJobMatch) JobMatchTab(result: r),
      if (r.hasCompanyResearch) CompanyResearchTab(result: r),
      KeywordsTab(result: r),
      SkillsTab(result: r),
      CoverLetterTab(result: r),
      InterviewTab(result: r),
      LearningPathTab(result: r),
    ];

    _tabController = TabController(length: _tabs.length, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final r = widget.result;
    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        title: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(r.candidateName, style: AppTextStyles.headingMedium),
            Row(
              children: [
                Text(r.jobTitle, style: AppTextStyles.bodySmall.copyWith(color: AppColors.primary)),
                if (r.hasJobDescription) ...[
                  const SizedBox(width: 8),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: AppColors.success.withOpacity(0.15),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text('JD Matched', style: AppTextStyles.bodySmall.copyWith(
                      color: AppColors.success, fontSize: 9,
                    )),
                  ),
                ],
              ],
            ),
          ],
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.copy_outlined, color: AppColors.textSecondary),
            tooltip: 'Copy report',
            onPressed: () => _share(r),
          ),
          const SizedBox(width: 4),
        ],
        bottom: TabBar(
          controller: _tabController,
          isScrollable: true,
          indicatorColor: AppColors.primary,
          indicatorWeight: 2,
          labelColor: AppColors.primary,
          unselectedLabelColor: AppColors.textSecondary,
          labelStyle: AppTextStyles.label.copyWith(fontSize: 12),
          tabAlignment: TabAlignment.start,
          tabs: _tabs.map((t) => Tab(text: t)).toList(),
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: _tabViews,
      ),
    );
  }

  void _share(CvAnalysis r) {
    final buffer = StringBuffer();
    buffer.writeln('CV Analysis Report — ${r.candidateName}');
    buffer.writeln('=============================');
    buffer.writeln('ATS Score: ${r.atsScore}/100');
    buffer.writeln('Career Level: ${r.careerLevel}');
    if (r.hasJobMatch) {
      buffer.writeln('Job Match: ${r.jobMatchAnalysis!.score}/100');
    }
    buffer.writeln('\nSummary:\n${r.overallSummary}');
    buffer.writeln('\nQuick Wins:');
    buffer.writeln(r.quickWins.map((q) => '• $q').join('\n'));
    buffer.writeln('\nGenerated by CV Analyzer Pro');
    Clipboard.setData(ClipboardData(text: buffer.toString()));
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Report copied to clipboard'),
          backgroundColor: Color(0xFF38BDF8),
          duration: Duration(seconds: 2),
        ),
      );
    }
  }
}
